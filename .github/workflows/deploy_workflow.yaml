name: Build and deploy to PyPI

on:
  release:
    types: [published]

jobs:
  build-n-publish:
    name: Build and publish Python 🐍 distributions 📦 to PyPI
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@master
    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
    - name: Install pep517
      run: >-
        python -m
        pip install
        wheel
        --user
    - name: Build a binary wheel and a source tarball
      run: >-
        python setup.py bdist_wheel
    - name: Publish distribution 📦 to Test PyPI
      uses: pypa/gh-action-pypi-publish@master
      with:
        password: ${{ secrets.test_pypi_password }}
        repository_url: https://test.pypi.org/legacy/
    - name: autochangelog-action
      id: ac
      uses: rubenfiszel/autochangelog-action@v0.11.0
      with:
        changelog_file: './CHANGES.rst'
        dry_run: false
        tag_prefix: 'v'
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Update changelog and manifest'
        title: 'ci: Release ${{ steps.ac.outputs.version }}'
        body: |
          Release v${{ steps.ac.outputs.version }}
        labels: autorelease
        branch: automatic-release-prs
        branch-suffix: none
    - name: Check outputs
      run: |
        echo "Pull Request Number - ${{ env.PULL_REQUEST_NUMBER }}"
        echo "Pull Request Number - ${{ steps.cpr.outputs.pr_number }}"
